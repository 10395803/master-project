% getLinearPoisson1dFEP1stiffness_f Compute stiffness matrix
% yielded by the application of linear finite elements (FE-P1) to the
% linear one-dimensional Poisson equation $-u''(x) = f(x)$ on $[a,b]$.
% The ODE should be completed with Dirichlet, Neumann or periodic boundary
% conditions. The "f" in the function name stands for "fast". Indeed, 
% persistent variables are used so to perform computations only when needed.
% 
% A = getLinearPoisson1dFEP1stiffness_f(a, b, K, f, BCLt, BCRt)
% \param a      left boundary of the domain
% \param b      right boundary of the domain
% \param K      number of elements
% \param f      RHS; this may be either an handle function or a cell array
%               of handle functions; in the latter case, the solution is
%               computed for each RHS
% \param BCLt   kind of left boundary condition; 'D' = Dirichlet, 'N' =
%               Neumann, 'P' = periodic
% \param BCRt   kind of right boundary condition; 'D' = Dirichlet, 'N' =
%               Neumann, 'P' = periodic
% \out   A      stiffness matrix

function A = getLinearPoisson1dFEP1stiffness_f(a, b, K, BCLt, BCRt)
	% Declare persistent variables
	persistent pa pb pK pBCLt pBCRt A
	
	% Exploiting persistent variables, compute stiffness matrix
	% only when strictly necessary, i.e. the first time this function
	% is called or when input arguments have changed with respect
	% to last call
	if isempty(pa)
		todo = 1;
	elseif (pa ~= a) || (pb ~= b) || (pK ~= K) || (pBCLt ~= BCLt) ...
		|| (pBCRt ~= BCRt)
		todo = 1;
	else 
		todo = 0;
	end
	
	% If needed, compute the stiffness matrix
	if todo
		% Set persistent variables
		pa = a;  pb = b;  pK = K;  pBCLt = BCLt;  pBCRt = BCRt;
		
		% Get uniform grid spacing
		h = (b-a) / (K-1);
		
		% Build the stiffness matrix
		A = 1/h * (diag(-ones(K-1,1),-1) + diag(2*ones(K,1)) + ...
		    diag(-ones(K-1,1),1));
		
		% Modify stiffness matrix applying left boundary conditions
		if strcmp(BCLt,'D')
		    A(1,1) = 1/h;  A(1,2) = 0;  
		elseif strcmp(BCLt,'P')
		    A(1,1) = 1/h;  A(1,2) = 0;  A(1,end) = -1/h;  
		end
		
		% Modify stiffness matrix applying right boundary conditions
		if strcmp(BCRt,'D')
		    A(end,end) = 1/h;  A(end,end-1) = 0;  
		elseif strcmp(BCRt,'P')
		    A(end,1) = 1/h;  A(end,end-1) = 0;  A(end,end) = -1/h;  
		end
	end
end
